<!-- TODO: This is a copy-and-modify from images.html.  If we care enough,
extract the commonality into a common place. -->

<style>
  #ipgroups {
    width: 720px;
  }
</style>

<div id="ipgroups">
  <div id="top"><p>IP Groups</p></div>

  <div id="listdiv">
    <table id="list" cellpadding="0" cellspacing="0">
      <thead>
        <tr>
          <th>Name</th>
          <th>Servers in group</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>

    <div id="newbutton">
      <input type="button" class="new" value="Create New"/>
    </div>

    <div class="newform" style="display:none">
      <h3>Create Shared IP Group</h3>
      <p>IP group name <input class="name"/></p>
      <p>Create empty <input type="checkbox" /></p>
      <p class="assign">Assign to server <span class="server"></span></p>

      <div class="message" style="color: red"></div>

      <div id="createcancel">
        <input type="button" class="save" value="Create"/>
        <input type="button" class="close" value="Cancel"/>
      </div>
    </div>

    <div class="spacer">&nbsp;</div>
  </div>

  <div id="bottom"></div>

  <!-- Holds an item to be cloned and added to the list once per entity -->
  <div id="listitem" style="display:none">
    <table> <!-- needed to store the <tr> which we actually care about -->
      <tr>
        <td class="name"></a></td>
        <td class="servers"></td>
      </tr>
    </table>
  </div>

  <div id="detail" style="display:none">
  <!-- Have JavaScript turn this into a popup/overlay using the jQuery Lightbox plugin? -->
    <div><span class="name"></span></div>
    <div>ID: <span class="id"></span></div>
    <div>Servers: <span class="servers"></span></div>

    <div><a href="#" class="delete">Delete</a></div>
  </div>

  <script>
    $(function() {

      var paginatedTable = new PaginatedTable({
        table: $("#ipgroups #list"),
        manager: service.sharedIpGroups,
        createRow: createRow,
        rowClick: fillDetails
      });

      var servers = {};
      service.servers.createList(true).forEachAsync({
        each: function(e) { servers[e.id] = e; }
      });

      // Hook up event handlers to HTML

      $("#ipgroups .new").click(function() {
        $("#ipgroups .newform").
          find(".name").val("").end().
          find(":checkbox").attr("checked", null).end().
          find(".server").html(selectBoxForMap(servers, "name")).end().
          find(".assign").attr("disabled", true).end().
          find(".message").hide().end().
          find(".save").val("Save").show().attr("disabled", false).end().
          find(".cancel").show().attr("disabled", false).end().
          show();
      });
      $("#ipgroups .newform :checkbox").change(function() {
        $("#ipgroups .newform .assign").attr("disabled", $(this).is(":checked"));
      });
      $("#ipgroups .newform .close").click(function() {
        $("#ipgroups .newform").hide();
      });
      $("#ipgroups .newform .save").click(function() {
        var newform = $("#ipgroups .newform");

        function empty(classname, msg) {
          if (newform.find(classname).val())
            return false;
          newform.find(".message").text(msg).show();
          return true;
        }

        if (!newform.find(":checkbox").is(":checked") &&
            empty(".server :selected", "Specify a server.")) return;
        if (empty(".name", "Specify a name.")) return;
            
        newform.
          find(".save").val("Saving...").attr("disabled", true).end().
          find(".message").hide().end().
          find(".cancel").attr("disabled", true).end();

        var chkd = newform.find(":checkbox").is(":checked");
        var serverid = chkd ? undefined : parseInt(newform.find(".server :selected").attr("id"));

        service.sharedIpGroups.create({
          entity: {
            name: newform.find(".name").val(),
            server: serverid
          },
          success: function(newEntity) {
            newEntity.servers = (serverid ? [ serverid ] : []);
            paginatedTable.addRowFor(newEntity);
            newform.hide();
            flash("Created new IP group '" + newEntity.name + "'.");
          },
          fault: function(fault) {
            newform.
              find(".save").val("Create").attr("disabled", false).end().
              find(".cancel").attr("disabled", false).end().
              find(".message").show().text(fault.message);
          }
        });

      });

      var detail = $("#ipgroups #detail");
      detail.find("a.delete").click(function() {
        var entity = detail.data("entity");

        verifyModal({
          yes: function() {
            service.sharedIpGroups.remove({
              entity: entity,
              success: function() {
                paginatedTable.rowFor(entity).remove();
                fillDetails(null);
                flash("Deleted.");
              },
              fault: flashFault
            });
          }
        });
      });

      function fillDetails(entity) {
        var $details = $("#ipgroups #detail");

        if (!entity) {
          $details.hide();
          return;
        }

        $details.
          show().
          data("entity", entity);

        var servernames = entity.servers.map(function(id) { return servers[id].name; });
        $details.
          find(".name").text(entity.name).end().
          find(".servers").text(servernames.join(", ") || "none").end();

        $details.
          find(".id").html(entity.id).end();
      }

      function createRow(entity) {
        entity.servers = entity.servers || [];

        var row = $("#ipgroups #listitem tr").
          clone().
          find(".name").text(entity.name).end().
          find(".servers").text(entity.servers.length).end();
        return row;
      }

      paginatedTable.loadPage();
    });
  </script>
</div>
