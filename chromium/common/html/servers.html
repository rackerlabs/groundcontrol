<style>
  /* TODO: make this page purty */
</style>

<div id="servers">
  <h2>Servers</h2>

  <div id="listdiv">
    <i>This table could maybe be a sidescrolling list of boxes a la 
      grooveshark</i>
    <table id="list" class="box">
      <thead>
        <tr>
          <th>Name</th>
          <th>Status</th>
          <th>Public IP</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
    <input type="button" class="new" value="Create New"/>
    <div class="newform box" style="display:none">
      <h3>Create New Server</h3>
      Name: <input class="name"/><br/>
      Image: <input class="imageid"/><br/> <!-- TODO image dropdown -->
      Flavor: <input class="flavorid"/><br/> <!-- TODO flavor dropdown -->
      <!-- TODO metadata keys & values? -->

      <input type="button" class="save" value="Create"/>
      <input type="button" class="saving" value="Saving..." 
             disabled style="display:none"/>
      <input type="button" class="close" value="Cancel"/>
    </div>

  </div>

  <!-- Holds an item to be cloned and added to the list once per entity -->
  <div id="listitem" style="display:none">
    <table> <!-- needed to store the <tr> which we actually care about -->
      <tr>
        <td><a href="#" class="name"></a></td>
        <td class="status"></td>
        <td class="ip"></td>
      </tr>
    </table>
  </div>

  <div id="detail" style="display:none" class="box">
    <div class="name"></div>
    ID: <span class="id"></span><br/>
    IP: <span class="ip"></span><br/>
    Image: <span class="image"></span>
    Flavor: <span class="flavor"></span><br/>

    <div><a href="#" class="delete">Delete</a></div>
    <div><a href="#" class="reboot">Reboot</a></div>
  </div>

  <script>
    $(function() {

      var paginatedTable = new PaginatedTable({
        table: $("#servers #list"),
        manager: service.servers,
        createRow: createRow,
        rowClick: fillDetails
      });

      var images = {};
      service.images.createList(true).forEachAsync({
        each: function(e) { images[e.id] = e; }
      });
      var flavors = {};
      service.flavors.createList(true).forEachAsync({
        each: function(e) { flavors[e.id] = e; }
      });

      // Hook up event handlers to HTML

      $("#servers .new").click(function() {
        $("#servers .newform").show();
      });
      $("#servers .newform .close").click(function() {
        $("#servers .newform").hide();
      });
      $("#servers .newform .save").click(function() {
        var newform = $("#servers .newform");

        function filled(classname, msg) {
          if (newform.find(classname).val())
            return true;
          flash(msg);
          return false;
        }

        if (!filled(".imageid", "Invalid image ID")) return;
        if (!filled(".flavorid", "Invalid flavor ID")) return;
        if (!filled(".name", "Specify a name")) return;
            
        newform.
          find(".save").hide().end().
          find(".saving").show().end();

        service.servers.create({
          entity: {
            name: newform.find(".name").val(),
            imageId: parseInt(newform.find(".imageid").val()),
            flavorId: parseInt(newform.find(".flavorid").val())
          },
          success: function(newServer) {
            paginatedTable.addRowFor(newServer);
            newform.
              hide().
              find(":text").val("").end().
              find(".save").show().end().
              find(".saving").hide().end();
            flash("Created new server '" + newServer.name + "'.");
          },
          fault: function(fault) {
            newform.
              find(".save").show().end().
              find(".saving").hide().end();
            flashFault(fault);
          }
        });

      });

      var detail = $("#servers #detail");
      detail.find("a.delete").click(function() {
        var server = detail.data("server");

        verifyModal({
          yes: function() {
            service.servers.remove({
              entity: server,
              success: function() {
                paginatedTable.rowFor(server).remove();
                fillDetails(null);
                flash("Deleted.");
              },
              fault: flashFault
            });
          }
        });
      });

      detail.find("a.reboot").click(function() {
        function doReboot(modal, hard) {
          modal.text("Rebooting...");
          modal.dialog("widget").find(":button").attr("disabled", true);
          var server = detail.data("server");
          service.servers.reboot({
            entity: server,
            hard: hard,
            success: function(updatedServer) {
              paginatedTable.replaceRowFor(server, updatedServer);
              fillDetails(null);
              modal.dialog("close");
              flash("Rebooted.");
            },
            fault: function(fault) {
              modal.dialog("close");
              flashFault(fault);
            }
          });
        }
        $("<div>What kind of reboot?</div>").dialog({
          title: "Confirm reboot",
          buttons: {
            "Hard": function() { doReboot($(this), true); },
            "Soft": function() { doReboot($(this), false); },
          }
        });
      });

      detail.find("a.namechange").click(function() {
        var server = detail.data("server");
        detail.find(".namedisplay").hide();
        detail.find(".nameedit").show().find(":text").val(server.name).select();
      });

      detail.find(".nameedit .save").click(function() {
        var newname = detail.find(".nameedit :text").val();
        if (!newname) {
          flash("Invalid name.");
          return;
        }

        detail.
          find(".nameedit .save").hide().end().
          find(".nameedit .saving").show().end();

        var server = detail.data("server");

        var oldname = server.name;
        server.name = newname;
        service.servers.update({
          entity: server,
          success: function(newServer) {
            paginatedTable.replaceRowFor(server, newServer);
            fillDetails(newServer);
            flash("Saved.");
          },
          fault: function(fault) {
            server.name = oldname;
            fillDetails(server);
            flashFault(fault);
          }
        });
      });

      function verifyModal(opts) {
        opts.text = opts.text || "Really?";
        opts.title = opts.title || "Confirm";
        var yes = opts.yes || function() {};
        var no = opts.no || function() {};
        var answer = function(callback) {
          return function() {
            $(this).dialog("close");
            callback();
          }
        }
        $("<div>").text(opts.text).dialog({
          title: opts.title,
          buttons: { "Yes": answer(yes), "No": answer(no) },
        });
      }

      function fillDetails(server) {
        if (!server) {
          $("#servers #detail").hide();
          return;
        }

        var $details = $("#servers #detail");
        $details.
          show().
          data("server", server);

        function saved(oldServer, newServer) {
          paginatedTable.replaceRowFor(oldServer, newServer);
          fillDetails(newServer);
          flash("Saved.");
        }

        $details.find(".name").showAndEdit({
          originalValue: server.name,
          display: function(value) { return value; },
          makeEditUi: function(value) { 
            return $('<input>').val(value).delay(0).select();
          },
          getValue: function($editUi) { return $editUi.val(); },
          save: function(value, success, failure) {
            if (!value) {
              failure("Specify a name.");
            }
            else {
              server.name = value;
              service.servers.update({ 
                entity: server, 
                success: function(newEntity) { 
                  saved(server, newEntity);
                  success();
                },
                fault: function(fault) { failure(fault.message); }
              });
            }
          }
        });

        // Return a <select> box with <option>s whose ids are the keys to the
        // map and whose values are map[key][textAttribute].  The <option> whose
        // id is selectedKey will be selected.
        function selectBoxForMap(map, textAttribute, selectedKey) {
          var result = $("<select>");
          for (var key in map) {
            $("<option>").
              attr("id", key).
              text(map[key][textAttribute]).
              attr("selected", (selectedKey == key)).
              appendTo(result);
          }
          return result;
        }

        $details.find(".image").showAndEdit({
          originalValue: server.imageId,
          display: function(value) { return images[value].name; },
          makeEditUi: function(imageIdToSelect) { 
            return selectBoxForMap(images, "name", imageIdToSelect);
          },
          getValue: function($editUi) {
            return parseInt($editUi.find(":selected").attr("id"));
          },
          save: function(value, success, failure) {
            service.servers.rebuild({ 
              entity: server,
              imageId: value,
              success: function(newEntity) { 
                saved(server, newEntity);
                success();
              },
              fault: function(fault) { failure(fault.message); }
            });
          }
        });

        $details.find(".flavor").showAndEdit({
          originalValue: server.flavorId,
          display: function(value) { return flavors[value].name; },
          makeEditUi: function(flavorIdToSelect) {
            return selectBoxForMap(flavors, "name", flavorIdToSelect);
          },
          getValue: function($editUi) {
            return parseInt($editUi.find(":selected").attr("id"));
          },
          save: function(value, success, failure) {
            service.servers.resize({ 
              entity: server,
              flavorId: value,
              success: function(newEntity) { 
                saved(server, newEntity);
                success();
              },
              fault: function(fault) { failure(fault.message); }
            });
          }
        });


        $details.
          find(".id").html(server.id).end().
          find(".ip").html(server.addresses.public[0]).end();

        // Reset visibility of elements that may have been played with
        // during e.g. a name edit
        $("#servers #detail").
          find("*").show().end().
          find(".nameedit").add(".saving").hide();
      }

      function createRow(server) {
        var row = $("#servers #listitem tr").
          clone().
          find(".name").html(server.name).end().
          find(".status").html(server.status).end().
          find(".ip").html(server.addresses.public[0]).end();
        return row;
      }


      paginatedTable.loadPage();

      //$("#stubui").load("../groundcontrol.html");
    });
  </script>

  <div id="stubui">
  </div>
</div>
