<style>
  /* TODO: make this page purty */
</style>

<div id="servers">
  <h2>Servers</h2>

  <div id="listdiv" class="box">
    <table id="list">
      <thead>
        <tr>
          <th>Name</th>
          <th>RAM size</th>
          <th>Public IP</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
    <input type="button" class="new" value="Create New"/>
    <div class="newform" style="display:none">
      <h3>Create New Server</h3>
      Name: <input class="name"/><br/>
      Image: <input class="imageid"/><br/> <!-- TODO image dropdown -->
      Flavor: <input class="flavorid"/><br/> <!-- TODO flavor dropdown -->
      <!-- TODO metadata keys & values? -->
      <input type="button" class="save" value="Create"/>
      <input type="button" class="saving" value="Saving..." 
             disabled style="display:none"/>
    </div>

  </div>

  <!-- Holds an item to be cloned and added to the list once per entity -->
  <div id="listitem" style="display:none">
    <table> <!-- needed to store the <tr> which we actually care about -->
      <tr>
        <td><a href="#" class="name"></a></td>
        <td class="ram"></td>
        <td class="ip"></td>
      </tr>
    </table>
  </div>

  <div id="detail" style="display:none" class="box">
    <div>
      <span class="namedisplay">
        <span class="name"></span>
        <a href="#" class="namechange">change</a>
      </span>
      <span class="nameedit" style="display:none">
        <input />
        <input type="button" class="save" value="Save"/>
        <input type="button" class="saving" value="Saving..." 
               disabled style="display:none" />
      </span>
    </div>
    ID: <span class="id"></span><br/>
    IP: <span class="ip"></span><br/>
    Image ID: <span class="imageid"></span><br/>
    Flavor ID: <span class="flavorid"></span><br/>

    <div><a href="#" class="delete">Delete</a></div>
  </div>

  <script>
    $(function() {

      var paginatedTable = new PaginatedTable({
        table: $("#servers #list"),
        manager: service.servers,
        createRow: createRow,
        rowClick: fillDetails
      });


      // Hook up event handlers to HTML

      $("#servers .new").click(function() {
        $("#servers .newform").show();
      });
      $("#servers .newform .save").click(function() {
        var newform = $("#servers .newform");

        function filled(classname, msg) {
          if (newform.find(classname).val())
            return true;
          flash(msg);
          return false;
        }

        if (!filled(".imageid", "Invalid image ID")) return;
        if (!filled(".flavorid", "Invalid flavor ID")) return;
        if (!filled(".name", "Specify a name")) return;
            
        newform.
          find(".save").hide().end().
          find(".saving").show().end();

        service.servers.create({
          entity: {
            name: newform.find(".name").val(),
            imageId: parseInt(newform.find(".imageid").val()),
            flavorId: parseInt(newform.find(".flavorid").val())
          },
          success: function(newServer) {
            paginatedTable.addRowFor(newServer);
            newform.
              hide().
              find(":text").val("").end().
              find(".save").show().end().
              find(".saving").hide().end();
            flash("Created new server '" + newServer.name + "'.");
          },
          fault: flashFault
        });

      });

      var detail = $("#servers #detail");
      detail.find("a.delete").click(function() {
        var server = detail.data("server");

        verifyModal({
          yes: function() {
            service.servers.remove({
              entity: server,
              success: function() {
                paginatedTable.rowFor(server).remove();
                detail.hide();
                flash("Deleted.");
              },
              fault: flashFault
            });
          }
        });
      });

      detail.find("a.namechange").click(function() {
        var server = detail.data("server");
        detail.find(".namedisplay").hide();
        detail.find(".nameedit").show().find(":text").val(server.name).select();
      });

      detail.find(".nameedit .save").click(function() {
        var newname = detail.find(".nameedit :text").val();
        if (!newname) {
          flash("Invalid name.");
          return;
        }

        detail.
          find(".nameedit .save").hide().end().
          find(".nameedit .saving").show().end();

        var server = detail.data("server");

        var oldname = server.name;
        server.name = newname;
        service.servers.update({
          entity: server,
          success: function(newServer) {
            paginatedTable.replaceRowFor(server, newServer);
            fillDetails(newServer);
            flash("Saved.");
          },
          fault: function(fault) {
            server.name = oldname;
            fillDetails(server);
            flashFault(fault);
          }
        });
      });

      function verifyModal(opts) {
        opts.text = opts.text || "Really?";
        opts.title = opts.title || "Confirm";
        var yes = opts.yes || function() {};
        var no = opts.no || function() {};
        var answer = function(callback) {
          return function() {
            $(this).dialog("close");
            callback();
          }
        }
        $("<div>").text(opts.text).dialog({
          title: opts.title,
          buttons: { "Yes": answer(yes), "No": answer(no) },
        });
      }

      function fillDetails(server) {
        $("#servers #detail").
          show().
          data("server", server).
          find(".name").html(server.name).end().
          find(".id").html(server.id).end().
          find(".ip").html(server.addresses.public[0]).end().
          find(".imageid").html(server.imageId).end().
          find(".flavorid").html(server.flavorId).end();

        // Reset visibility of elements that may have been played with
        // during e.g. a name edit
        $("#servers #detail").
          find("*").show().end().
          find(".nameedit").add(".saving").hide();
      }

      function createRow(server) {
        var row = $("#servers #listitem tr").
          clone().
          find(".name").html(server.name).end().
          find(".ram").html("unknown").end().
          find(".ip").html(server.addresses.public[0]).end();
        return row;
      }


      paginatedTable.loadPage();

      //$("#stubui").load("../groundcontrol.html");
    });
  </script>

  <div id="stubui">
  </div>
</div>
