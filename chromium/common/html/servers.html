<style>
  /* TODO: make this page purty */
  #servers #detail .name:not(input) {
    font-size:30px;
  }
</style>

<div id="servers">
  <h2>Servers</h2>

  <div id="listdiv">
    <i>This table could maybe be a sidescrolling list of boxes a la 
      grooveshark</i>
    <table id="list" class="box">
      <thead>
        <tr>
          <th>Name</th>
          <th>Status</th>
          <th>Public IP</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
    <input type="button" class="new" value="Create New"/>
    <div class="newform box" style="display:none">
      <h3>Create New Server</h3>
      Name: <input class="name"/><br/>
      Image: <span class="image"></span><br/>
      Size: <span class="flavor"></span><br/>
      <!-- TODO metadata keys & values? -->

      <div class="message" style="color: red"></div>

      <input type="button" class="save" value="Create"/>
      <input type="button" class="close" value="Cancel"/>
    </div>

  </div>

  <!-- Holds an item to be cloned and added to the list once per entity -->
  <div id="listitem" style="display:none">
    <table> <!-- needed to store the <tr> which we actually care about -->
      <tr>
        <td><a href="#" class="name"></a></td>
        <td class="status"></td>
        <td class="ip"></td>
      </tr>
    </table>
  </div>

  <div id="detail" style="display:none" class="box">
    <div><span class="name"></span></div>
    <div>ID:&nbsp;<span class="id"></span></div>
    <div>IP:&nbsp;<span class="ip"></span></div>
    <div>Image:&nbsp;<span class="image"></span></div>
    <div>Size:&nbsp;<span class="flavor"></span></div>
    <div>Status:&nbsp;<span class="status"></span></div>

    <div><a href="#" class="delete">Delete</a></div>
    <div><a href="#" class="reboot">Reboot</a></div>
  </div>

  <script>
    $(function() {

      var paginatedTable = new PaginatedTable({
        table: $("#servers #list"),
        manager: service.servers,
        createRow: createRow,
        rowClick: fillDetails
      });

      var images = {};
      service.images.createList(true).forEachAsync({
        each: function(e) { images[e.id] = e; }
      });
      var flavors = {};
      service.flavors.createList(true).forEachAsync({
        each: function(e) { flavors[e.id] = e; }
      });

      // Hook up event handlers to HTML

      $("#servers .new").click(function() {
        $("#servers .newform").
          find(".image").html(selectBoxForMap(images, "name")).end().
          find(".flavor").html(selectBoxForMap(flavors, "name")).end().
          find(".name").val("").end().
          find(".message").hide().end().
          find(".save").show().attr("disabled", false).end().
          find(".cancel").show().attr("disabled", false).end().
          show();
      });
      $("#servers .newform .close").click(function() {
        $("#servers .newform").hide();
      });
      $("#servers .newform .save").click(function() {
        var newform = $("#servers .newform");

        function empty(classname, msg) {
          if (newform.find(classname).val())
            return false;
          newform.find(".message").text(msg).show();
          return true;
        }

        if (empty(".image :selected", "Specify an image.")) return;
        if (empty(".flavor :selected", "Specify a size.")) return;
        if (empty(".name", "Specify a name.")) return;
            
        newform.
          find(".save").val("Saving...").attr("disabled", true).end().
          find(".message").hide().end().
          find(".cancel").attr("disabled", true).end();

        service.servers.create({
          entity: {
            name: newform.find(".name").val(),
            imageId: parseInt(newform.find(".image :selected").attr("id")),
            flavorId: parseInt(newform.find(".flavor :selected").attr("id"))
          },
          success: function(newServer) {
            paginatedTable.addRowFor(newServer);
            newform.
              hide().
              find(":text").val("").end().
              find(".save").val("Create").attr("disabled", false).end().
              find(".cancel").attr("disabled", false).end().
              find(".message").hide().end();
            flash("Created new server '" + newServer.name + "'.");
          },
          fault: function(fault) {
            newform.
              find(".save").val("Create").attr("disabled", false).end().
              find(".cancel").attr("disabled", false).end().
              find(".message").show().text(fault.message);
          }
        });

      });

      var detail = $("#servers #detail");
      detail.find("a.delete").click(function() {
        var server = detail.data("server");

        // TODO: inline this if no one else uses it
        function verifyModal(opts) {
          opts.text = opts.text || "Really?";
          opts.title = opts.title || "Confirm";
          var yes = opts.yes || function() {};
          var no = opts.no || function() {};
          var answer = function(callback) {
            return function() {
              $(this).dialog("close");
              callback();
            }
          }
          $("<div>").text(opts.text).dialog({
            title: opts.title,
            buttons: { "Yes": answer(yes), "No": answer(no) },
          });
        }

        verifyModal({
          yes: function() {
            service.servers.remove({
              entity: server,
              success: function() {
                paginatedTable.rowFor(server).remove();
                fillDetails(null);
                flash("Deleted.");
              },
              fault: flashFault
            });
          }
        });
      });

      detail.find("a.reboot").click(function() {
        function doReboot(modal, hard) {
          modal.text("Rebooting...");
          modal.dialog("widget").find(":button").attr("disabled", true);
          var server = detail.data("server");
          service.servers.reboot({
            entity: server,
            hard: hard,
            success: function(updatedServer) {
              modal.dialog("close");
              updated(server, updatedServer, "Reboot begun.");
            },
            fault: function(fault) {
              modal.dialog("close");
              flashFault(fault);
            }
          });
        }
        $("<div>What kind of reboot?</div>").dialog({
          title: "Confirm reboot",
          buttons: {
            "Hard": function() { doReboot($(this), true); },
            "Soft": function() { doReboot($(this), false); },
          }
        });
      });

      function updated(oldServer, newServer, message) {
        paginatedTable.replaceRowFor(oldServer, newServer);
        if ($("#servers #detail").data("server") == oldServer)
          fillDetails(newServer);
        flash(message);
      }

      // Return a <select> box with <option>s whose ids are the keys to the
      // map and whose values are map[key][textAttribute].  The <option> whose
      // id is selectedKey will be selected.
      function selectBoxForMap(map, textAttribute, selectedKey) {
        var result = $("<select>");
        for (var key in map) {
          $("<option>").
            attr("id", key).
            text(map[key][textAttribute]).
            attr("selected", (selectedKey == key)).
            appendTo(result);
        }
        return result;
      }

      function fillDetails(server) {
        var $details = $("#servers #detail");

        if (!server) {
          $details.hide();
          return;
        }

        $details.
          show().
          data("server", server);

        $details.find(".name").showAndEdit({
          originalValue: server.name,
          display: function(value) { return value; },
          makeEditUi: function(value) { 
            return $('<input>').val(value).delay(0).select();
          },
          getValue: function($editUi) { return $editUi.val(); },
          save: function(value, success, failure) {
            if (!value) {
              failure("Specify a name.");
            }
            else {
              server.name = value;
              service.servers.update({ 
                entity: server, 
                success: function(newEntity) { 
                  updated(server, newEntity, "Saved.");
                  success();
                },
                fault: function(fault) { failure(fault.message); }
              });
            }
          }
        });

        $details.find(".image").showAndEdit({
          originalValue: server.imageId,
          display: function(value) { return images[value].name; },
          makeEditUi: function(imageIdToSelect) { 
            return selectBoxForMap(images, "name", imageIdToSelect);
          },
          getValue: function($editUi) {
            return parseInt($editUi.find(":selected").attr("id"));
          },
          save: function(value, success, failure) {
            service.servers.rebuild({ 
              entity: server,
              imageId: value,
              success: function(newEntity) { 
                updated(server, newEntity, "Rebuild started.");
                success();
              },
              fault: function(fault) { failure(fault.message); }
            });
          }
        });

        $details.find(".flavor").showAndEdit({
          originalValue: server.flavorId,
          display: function(value) { return flavors[value].name; },
          makeEditUi: function(flavorIdToSelect) {
            return selectBoxForMap(flavors, "name", flavorIdToSelect);
          },
          getValue: function($editUi) {
            return parseInt($editUi.find(":selected").attr("id"));
          },
          save: function(value, success, failure) {
            service.servers.resize({ 
              entity: server,
              flavorId: value,
              success: function(newEntity) { 
                updated(server, newEntity, "Resize started.");
                success();
              },
              fault: function(fault) { failure(fault.message); }
            });
          }
        });

        $details.
          find(".id").html(server.id).end().
          find(".ip").html(server.addresses.public[0]).end().
          find(".status").text(server.status).end();

      }

      function createRow(server) {
        var row = $("#servers #listitem tr").
          clone().
          find(".name").html(server.name).end().
          find(".status").html(server.status).end().
          find(".ip").html(server.addresses.public[0]).end();
        return row;
      }

      paginatedTable.loadPage();

      //$("#stubui").load("../groundcontrol.html");
    });
  </script>

  <div id="stubui">
  </div>
</div>
