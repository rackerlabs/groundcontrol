<style>
  /* TODO: make this page purty */
</style>

<div id="servers">
  <h2>Servers</h2>

  <div id="listdiv" class="box">
    <table id="list">
      <thead>
        <tr>
          <th>Name</th>
          <th>RAM size</th>
          <th>Public IP</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
  </div>

  <!-- Holds an item to be cloned and added to the list once per entity -->
  <div id="listitem" style="display:none">
    <table> <!-- needed to store the <tr> which we actually care about -->
      <tr>
        <td><a href="#" class="name"></a></td>
        <td class="ram"></td>
        <td class="ip"></td>
      </tr>
    </table>
  </div>

  <div id="detail" style="display:none" class="box">
    <h3><span class="name"></span></h3>
    ID: <span class="id"></span><br/>
    IP: <span class="ip"></span><br/>

    <div><a href="#" class="delete">Delete</a></div>
  </div>

  <div id="stubui">
  </div>

  <script>
    function PaginatedTable(opts) {
      var that = this;

      that._manager = opts.manager;
      that._table = opts.table;
      that._createRow = opts.createRow;
      that._currentPage = 0;

      if (opts.rowClick) {
        that._table.find("tr.dataRow").live("click", function() {
          var theRow = $(this);
          opts.rowClick(theRow.data("entity"));
        });
      }

      var numCols = that._table.find("thead tr td").length;
      that._more = $('<tr><td></td></tr>');
      that._more.find("td").
        attr("colspan", numCols).
        append('<a href="#">More...</a>').
        append('<span class="loading">Loading...</span>');
      that._more.
        find(".loading").hide().end().
        find("a").click(function() { that.loadPage(); }).end();

      that._table.find("tbody").append(this._more);
    }

    PaginatedTable.prototype = {
      // Append a page of entities to the list.
      loadPage: function() {
        this._more.
          find("a").hide().end().
          find(".loading").show();

        var PAGE_SIZE = 10;
        var offset = this._currentPage * PAGE_SIZE;

        var that = this;
        that._manager.createList(true, offset, PAGE_SIZE).forEachAsync({
          each: function(entity) {
            var row = that._createRow(entity);
            that._more.before(row);
            row.
              addClass("dataRow").
              data("entity", entity);
          },
          complete: function(count) {
            that._currentPage += 1;

            if (count == PAGE_SIZE) { // didn't reach end of list
              that._more.
                find(".loading").hide().end().
                find("a").show();
            }
            else {
              that._more.hide();
            }
          }
        });
      },

      // Return a jQuery ojbect containing the row(s) for the given entity
      rowFor: function(entity) {
        return this._table.
          find("tr.dataRow").
          filter(function() {
            return $(this).data("entity") == entity;
          });
      }
    }

    function verifyModal(opts) {
      opts.text = opts.text || "Really?";
      opts.title = opts.title || "Confirm";
      var yes = opts.yes || function() {};
      var no = opts.no || function() {};
      var answer = function(callback) {
        return function() {
          $(this).dialog("close");
          callback();
        }
      }
      $("<div>").text(opts.text).dialog({
        title: opts.title,
        buttons: { "Yes": answer(yes), "No": answer(no) },
      });
    }

    $(function() {
      function fillDetails(server) {
        $("#servers #detail").
          show().
          data("server", server).
          find(".name").html(server.name).end().
          find(".id").html(server.id).end().
          find(".ip").html(server.addresses.public[0]).end();
      }

      function createRow(server) {
        var row = $("#servers #listitem tr").
          clone().
          find(".name").html(server.name).end().
          find(".ram").html("unknown").end().
          find(".ip").html(server.addresses.public[0]).end();
        return row;
      }

      var detail = $("#servers #detail");

      detail.find("a.delete").click(function() {
        var server = detail.data("server");

        verifyModal({
          yes: function() {
            service.servers.remove({
              entity: server,
              success: function() {
                serverList.rowFor(server).remove();
                detail.hide();
                flash("Deleted.");
              },
              fault: function(fault) {
                flash("Oops! " + fault.message);
              }
            });
          }
        });
      });

      var serverList = new PaginatedTable({
        table: $("#servers #list"),
        manager: service.servers,
        createRow: createRow,
        rowClick: fillDetails
      });

      serverList.loadPage();

      //$("#stubui").load("../groundcontrol.html");
    });
  </script>
</div>
