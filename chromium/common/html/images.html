<!-- TODO: This is a copy-and-modify from servers.html.  If we care enough,
extract the commonality into a common place. -->

<style>
  #images {
    width: 720px;
  }
</style>

<div id="images">
  <div id="top"><p>Images</p></div>

  <div id="listdiv">
    <table id="list" cellpadding="0" cellspacing="0">
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>

    <div id="newbutton">
      <input type="button" class="new" value="Create New"/>
    </div>

    <div class="newform" style="display:none">
      <h3>Create New Image</h3>
      <p>Image name <input class="name"/></p>
      <p>Server <span class="server"></span></p>

      <div class="message" style="color: red"></div>

      <div id="createcancel">
        <input type="button" class="save" value="Create"/>
        <input type="button" class="close" value="Cancel"/>
      </div>
    </div>

    <div class="spacer">&nbsp;</div>
  </div>

  <div id="bottom"></div>

  <!-- Holds an item to be cloned and added to the list once per entity -->
  <div id="listitem" style="display:none">
    <table> <!-- needed to store the <tr> which we actually care about -->
      <tr>
        <td class="name"></a></td>
        <td class="type"></td>
        <td class="status"></td>
      </tr>
    </table>
  </div>

  <div id="detail" style="display:none">
  <!-- Have JavaScript turn this into a popup/overlay using the jQuery Lightbox plugin? -->
    <div><span class="name"></span></div>
    <div>ID: <span class="id"></span></div>
    <div>Type: <span class="type"></span></div>
    <div>Status: <span class="status"></span></div>

    <div><a href="#" class="delete">Delete</a></div>
  </div>

  <script>
    $(function() {

      var paginatedTable = new PaginatedTable({
        table: $("#images #list"),
        manager: service.images,
        createRow: createRow,
        rowClick: fillDetails
      });

      var servers = {};
      service.servers.createList(true).forEachAsync({
        each: function(e) { servers[e.id] = e; }
      });

      // Hook up event handlers to HTML

      $("#images .new").click(function() {
        $("#images .newform").
          find(".server").html(selectBoxForMap(servers, "name")).end().
          find(".name").val("").end().
          find(".message").hide().end().
          find(".save").show().attr("disabled", false).end().
          find(".cancel").show().attr("disabled", false).end().
          show();
      });
      $("#images .newform .close").click(function() {
        $("#images .newform").hide();
      });
      $("#images .newform .save").click(function() {
        var newform = $("#images .newform");

        function empty(classname, msg) {
          if (newform.find(classname).val())
            return false;
          newform.find(".message").text(msg).show();
          return true;
        }

        if (empty(".server :selected", "Specify a server to back up.")) return;
        if (empty(".name", "Specify a name.")) return;
            
        newform.
          find(".save").val("Saving...").attr("disabled", true).end().
          find(".message").hide().end().
          find(".cancel").attr("disabled", true).end();

        service.images.create({
          entity: {
            name: newform.find(".name").val(),
            serverId: parseInt(newform.find(".server :selected").attr("id"))
          },
          success: function(newEntity) {
            paginatedTable.addRowFor(newEntity);
            newform.
              hide().
              find(":text").val("").end().
              find(".save").val("Create").attr("disabled", false).end().
              find(".cancel").attr("disabled", false).end().
              find(".message").hide().end();
            flash("Created new image '" + newEntity.name + "'.");
            // TODO: this doesn't work properly yet.
            var notifyCallback = function(event) {
              if (event.error) return;
              paginatedTable.replaceRowFor(newEntity, event.targetEntity);
              newEntity = event.targetEntity;
              if (event.targetEntity.status == 'ACTIVE')
                service.images.stopNotify(event.targetEntity, notifyCallback);
            }
            service.images.notify(newEntity, notifyCallback);
          },
          fault: function(fault) {
            newform.
              find(".save").val("Create").attr("disabled", false).end().
              find(".cancel").attr("disabled", false).end().
              find(".message").show().text(fault.message);
          }
        });

      });

      var detail = $("#images #detail");
      detail.find("a.delete").click(function() {
        var entity = detail.data("image");

        // TODO: inline this if no one else uses it
        function verifyModal(opts) {
          opts.text = opts.text || "Really?";
          opts.title = opts.title || "Confirm";
          var yes = opts.yes || function() {};
          var no = opts.no || function() {};
          var answer = function(callback) {
            return function() {
              $(this).dialog("close");
              callback();
            }
          }
          $("<div>").text(opts.text).dialog({
            title: opts.title,
            buttons: { "Yes": answer(yes), "No": answer(no) },
          });
        }

        verifyModal({
          yes: function() {
            service.images.remove({
              entity: entity,
              success: function() {
                paginatedTable.rowFor(entity).remove();
                fillDetails(null);
                flash("Deleted.");
              },
              fault: flashFault
            });
          }
        });
      });

      function updated(oldEntity, newEntity, message) {
        paginatedTable.replaceRowFor(oldEntity, newEntity);
        if ($("#images #detail").data("image") == oldEntity)
          fillDetails(newEntity);
        flash(message);
      }

      // Return a <select> box with <option>s whose ids are the keys to the
      // map and whose values are map[key][textAttribute].  The <option> whose
      // id is selectedKey will be selected.
      function selectBoxForMap(map, textAttribute, selectedKey) {
        var result = $("<select>");
        for (var key in map) {
          $("<option>").
            attr("id", key).
            text(map[key][textAttribute]).
            attr("selected", (selectedKey == key)).
            appendTo(result);
        }
        return result;
      }

      function fillDetails(entity) {
        var $details = $("#images #detail");

        if (!entity) {
          $details.hide();
          return;
        }

        $details.
          show().
          data("image", entity);

        var server = servers[entity.serverId];
        $details.
          find(".name").text(entity.name).end().
          find(".type").text(server ? server.name + " backup" : "OS").end().
          find(".status").html(entity.status).end();

        $details.
          find(".id").html(entity.id).end();
      }

      function createRow(entity) {
        var server = servers[entity.serverId];
        var row = $("#images #listitem tr").
          clone().
          find(".name").text(entity.name).end().
          find(".type").text(server ? server.name + " backup" : "OS").end().
          find(".status").html(entity.status).end();
        return row;
      }

      paginatedTable.loadPage();
    });
  </script>
</div>
