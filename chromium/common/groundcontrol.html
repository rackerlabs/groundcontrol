<html>
  <head>
    <title>GroundControl</title>
    <style>
      .box {
        border: 1px solid gray;
        margin:5px;
        padding:5px;
        background: white;
      }
      .leftside {
        float:left;
        width:400px;
      }
      #controls {
        width:600px;
        height: 90%;
        float:right;
        overflow-y:scroll;
        background: #ddddff;
        border: 2px solid #222222;
        -webkit-border-radius: 5px;
        -moz-border-radius: 5px;
      }
      #ajaxes {
        clear:left;
        border: 1px solid black;
        padding-left:5px;
      }
    </style>
    <script src="jquery/jquery-1.4.2.min.js"></script>
    <script src="functions.js"></script>
    <script src="cloudservers/service.js"></script>
    <script src="cloudservers/faults.js"></script>
    <script src="cloudservers/entitymanager.js"></script>
    <script src="cloudservers/servermanager.js"></script>
    <script src="cloudservers/notifypoller.js"></script>
    <script src="cloudservers/entitylist.js"></script>
    <script src="cloudservers/backupschedule.js"></script>
    <script>
      $(function() {
        $('#ajaxes').append("Talking?: ").ajaxStart(function() { 
          $(this).append("Y ");
          $(this).css("background", "#ddddff");
        }).ajaxStop(function() { 
          $(this).append("N ");
          $(this).css("background", "white");
        });

        var client = com.rackspace.cloud.servers.api.client;
        service = new client.CloudServersService({
          username: "gundlach",
          apiKey: "c36ec1e44e2e2947f8e155a3a122a358"
        });
        $("#msg").text("'service' object authenticated.");
        servers = service.createServerManager();
      });

      function displayFault(fault) {
        $("#msg").html("FAULT: " + JSON.stringify(fault));
      }

      function toHtml(obj) {
        var html = "{<br/>";
        for (var key in obj) {
          if (typeof obj[key] == "object")
            html += (key + ": " + toHtml(obj[key]) + "<br/>");
          else
            html += (key + ": " + obj[key] + "<br/>");
        }
        html = html + "}";
        return html;
      }

      var singleEntity;
      function repaint() {
        singleEntity = singleEntity || {};
        $("#response").html(toHtml(singleEntity));
        $("span.entityId").text(singleEntity.id);
      }

      $(function() {
        $("#fetch :button").click(function() {
          var id = $("#fetch :text").val();
          servers.find({
            id:id, 
            success:function(entity) {
              $("#msg").html("Fetched.");
              singleEntity = entity;
              repaint();
            },
            fault: displayFault
          });
        });

        $("#refresh :button").click(function() {
          servers.refresh({
            entity:singleEntity,
            success:function(entity) {
              singleEntity = entity;
              $("#msg").html("Refreshed.");
              repaint();
            },
            fault: displayFault
          });
        });

        $("#remove :button").click(function() {
          servers.remove({
            entity:singleEntity,
            success:function() {
              singleEntity = undefined;
              $("#msg").html("Removed.");
              repaint();
            },
            fault: displayFault
          });
        });

        $("#update :button").click(function() {
          singleEntity.name = $("#update .serverName").val();

          if ($("#update .serverPass").val().length != 0)
            singleEntity.adminPass = $("#update .serverPass").val();

          servers.update({
            entity:singleEntity,
            success:function(entity) {
              singleEntity = entity;
              $("#msg").html("Updated.");
              repaint();
            },
            fault: displayFault
          });
        });

        $("#wait :button").click(function() {
          servers.wait({
            entity:singleEntity,
            success:function(entity) {
              singleEntity = entity;
              $("#msg").html("Done waiting.");
              repaint();
            },
            fault: displayFault
          });
        });

        $("#create :button").click(function() {
          var newEntity = {
            name: $("#create .serverName").val(),
            imageId: parseInt($("#create .serverImageId").val()),
            flavorId: parseInt($("#create .serverFlavorId").val()),
            metadata: { testMetadata: $("#create .serverMetadataKey").val() }
          };

          servers.create({
            entity:newEntity,
            success:function(entity) {
              singleEntity = entity;
              $("#msg").html("Created.");
              repaint();
            },
            fault: displayFault
          });
        });

        $("#list :button").click(function() {
          var lm = $("#list .serverLastModified").val();
          if (lm.length == 0) lm = undefined;
          var offset = $("#list .serverOffset").val();
          if (offset.length == 0) offset = undefined;
          var limit = $("#list .serverLimit").val();
          if (limit.length == 0) limit = undefined;

          if (lm)
            var list = servers.createDeltaList(true, lm, offset, limit);
          else
            var list = servers.createList(true, offset, limit);

          function handler(s) {
            $("#response").append(toHtml(s));
          }
          $("#response").html("");
          if ($("#list :radio:checked").val() == "async")
          {
            list.forEachAsync({
              each: handler,
              complete: function() { $("#response").append("DONE"); },
              fault: displayFault
            });
          }
          else {
            try {
              while (list.hasNext()) {
                handler(list.next());
              }
              $("#response").append("DONE");
            }
            catch (fault) {
              displayFault(fault);
            }
          }
        });

        $("#reboot :button").click(function() {
          servers.reboot({
            entity:singleEntity,
            hard: $(this).val() == "Hard",
            success:function(theEntity) {
              singleEntity = theEntity;
              $("#msg").html("Rebooted.");
              repaint();
            },
            fault: displayFault
          });
        });

        $("#rebuild :button").click(function() {
          servers.rebuild({
            entity:singleEntity,
            imageId: parseInt($("#rebuild :text").val()),
            success:function(theEntity) {
              singleEntity = theEntity;
              $("#msg").html("Rebuilt.");
              repaint();
            },
            fault: displayFault
          });
        });

        $("#resize :button").click(function() {
          servers.resize({
            entity:singleEntity,
            flavorId: parseInt($("#resize :text").val()),
            success:function(theEntity) {
              singleEntity = theEntity;
              $("#msg").html("Resized.");
              repaint();
            },
            fault: displayFault
          });
        });

        $("#confirmresize :button").click(function() {
          servers.confirmResize({
            entity:singleEntity,
            success:function(theEntity) {
              singleEntity = theEntity;
              $("#msg").html("Resize confirmed.");
              repaint();
            },
            fault: displayFault
          });
        });

        $("#revertresize :button").click(function() {
          servers.revertResize({
            entity:singleEntity,
            success:function(theEntity) {
              singleEntity = theEntity;
              $("#msg").html("Resize reverted.");
              repaint();
            },
            fault: displayFault
          });
        });

        $("#getbackupschedule :button").click(function() {
          servers.getSchedule({
            entity:singleEntity,
            success:function(schedule) {
              $("#msg").html("Fetched backup schedule.");
              $("#response").html(toHtml(schedule)).append("DONE");
            },
            fault: displayFault
          });
        });

        $("#setbackupschedule :button").click(function() {
          var weekly = $("#setbackupschedule .scheduleWeekly").val();
          var daily = $("#setbackupschedule .scheduleDaily").val();
          var enabled = $("#setbackupschedule .scheduleEnabled").val();
          servers.setSchedule({
            entity:singleEntity,
            weekly: weekly.length > 0 ? parseInt(weekly) : undefined,
            daily: daily.length > 0 ? parseInt(daily) : undefined,
            enabled: enabled.length > 0 ? (enabled == 'y') : undefined,
            success:function(newEntity) {
              theEntity = newEntity;
              $("#msg").html("Set backup schedule for the server.");
              repaint();
            },
            fault: displayFault
          });
        });

      });
    </script>
  </head>
  <body>
    <div id="ajaxes"></div>
    <div class="leftside">
      <div id="msg"></div>
      <div>Response:</div>
      <div id="response" style="font-size:x-small"></div>
    </div>
    <div id="controls">
      <div id="fetch" class="control box">
        Fetch ID: <input value="186177"/> <input type="button" value="Go"/>
      </div>
      <div id="refresh" class="control box">
        Refresh ID <span class="entityId"></span>: <input type="button" value="Go"/>
      </div>
      <div id="update" class="control box">
        Update ID <span class="entityId"></span>:<br/>
        Name: <input class="serverName"/><br/>
        Pass: <input class="serverPass"/><br/>
        <input type="button" value="Go"/>
      </div>
      <div id="wait" class="control box">
        Wait for ID <span class="entityId"></span> to be not in flux:
        <input type="button" value="Go"/>
      </div>
      <div id="remove" class="control box">
        Remove ID <span class="entityId"></span>: <input type="button" value="Go"/>
      </div>
      <div id="create" class="control box">
        Create new server:<br/>
        Name: <input class="serverName"/><br/>
        Image ID : <input class="serverImageId"/><br/>
        Flavor ID : <input class="serverFlavorId"/><br/>
        Value for metadata (blank is OK): <input class="serverMetadataKey"/><br/>
        <input type="button" value="Go"/>
      </div>
      <div id="list" class="control box">
        List servers<br/>
        Since Last-Modified date of: (blank is OK) 
        <input class="serverLastModified"/><br/>
        Offset of: (blank is OK) <input class="serverOffset"/><br/>
        Limit of: (blank is OK) <input class="serverLimit"/><br/>
        <input type="radio" checked name="r" value="async"> Async<br/>
        <input type="radio" name="r" value="sync"> Sync<br/>
        <input type="button" value="Go"/>
      </div>
      <div id="reboot" class="control box">
        Reboot ID <span class="entityId"></span>:
        <input type="button" value="Hard"/>
        <input type="button" value="Soft"/>
      </div>
      <div id="rebuild" class="control box">
        Rebuild ID <span class="entityId"></span>:
        New imageId = <input />
        <input type="button" value="Go"/>
      </div>
      <div id="resize" class="control box">
        Resize ID <span class="entityId"></span>:
        New flavorId = <input />
        <input type="button" value="Go"/>
      </div>
      <div id="confirmresize" class="control box">
        Confirm resize for ID <span class="entityId"></span>:
        <input type="button" value="Go"/>
      </div>
      <div id="revertresize" class="control box">
        Revert resize for ID <span class="entityId"></span>:
        <input type="button" value="Go"/>
      </div>
      <div id="getbackupschedule" class="control box">
        Get backup schedule for ID <span class="entityId"></span>:
        <input type="button" value="Go"/>
      </div>
      <div id="setbackupschedule" class="control box">
        Set backup schedule for ID <span class="entityId"></span>:<br/>
        Day of the week (optional): <input class="scheduleWeekly"><br/>
        Hour of the day (optional): <input class="scheduleDaily"><br/>
        Enabled? (y/n) (optional): <input class="scheduleEnabled"><br/>
        <input type="button" value="Go"/>
      </div>
    </div>
  </body>
</html>

